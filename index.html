<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FF Store - Topup App</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #2196F3; --bg: #F8FAFC; --white: #FFFFFF; --text: #1E293B; --border: #E2E8F0; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); padding-bottom: 80px; }

        /* Auth Screen */
        #auth-screen { position: fixed; inset: 0; background: white; z-index: 2000; padding: 30px; display: flex; flex-direction: column; justify-content: center; text-align: center; }
        .input-box { width: 100%; padding: 14px; background: #F1F5F9; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border); outline: none; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 12px; font-weight: 600; width: 100%; cursor: pointer; }

        /* App UI */
        .app-header { background: var(--white); padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .header-balance { background: #EFF6FF; color: var(--primary); padding: 6px 14px; border-radius: 50px; font-weight: 700; font-size: 14px; }

        .banner-container { width: 100%; height: 160px; overflow: hidden; position: relative; margin-top: 5px; }
        .banner-wrapper { display: flex; transition: 0.5s; height: 100%; }
        .banner-slide { min-width: 100%; height: 100%; background-size: cover; background-position: center; }

        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 15px; }
        .pkg-card { background: white; padding: 20px; border-radius: 18px; text-align: center; border: 1px solid var(--border); }
        .pkg-amt { font-weight: 700; font-size: 18px; display: block; }
        .pkg-price { color: var(--primary); font-weight: 600; font-size: 14px; }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid var(--border); z-index: 100; }
        .nav-icon { text-align: center; color: #94A3B8; font-size: 10px; flex: 1; }
        .nav-icon.active { color: var(--primary); }
        .nav-icon i { font-size: 20px; display: block; margin-bottom: 4px; }

        .list-item { background: white; padding: 15px; border-radius: 14px; display: flex; justify-content: space-between; align-items: center; margin: 0 15px 10px; border: 1px solid var(--border); }
        .status-badge { font-size: 10px; padding: 4px 8px; border-radius: 5px; font-weight: 700; text-transform: uppercase; }
        .st-pending { color: #D97706; background: #FEF3C7; }
        .st-success { color: #059669; background: #D1FAE5; }

        .modal { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: none; overflow-y: auto; }
        .page { display: none; }
        .page.active { display: block; }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="auth-screen">
        <h2 style="margin-bottom: 10px; color: var(--primary);">FF Store Login</h2>
        <p style="margin-bottom: 30px; color: #64748B;">Enter your email to continue</p>
        <input type="email" id="login-email" class="input-box" placeholder="Email Address">
        <input type="password" id="login-pass" class="input-box" placeholder="Password (min 6 chars)">
        <button class="btn-main" onclick="handleAuth()">Login / Register</button>
    </div>

    <!-- Main App UI -->
    <div id="main-app" style="display: none;">
        <div class="app-header">
            <div style="font-weight:800; color: var(--primary);">FF STORE</div>
            <div class="header-balance" onclick="nav('wallet')"><i class="fa-solid fa-wallet"></i> ₹<span id="header-bal-amt">0</span></div>
        </div>

        <!-- HOME -->
        <div id="home-page" class="page active">
            <div class="banner-container">
                <div class="banner-wrapper" id="banner-track"></div>
            </div>
            <h4 style="margin: 20px 15px 10px;">Select Diamond Pack</h4>
            <div class="grid" id="packages-grid"></div>
        </div>

        <!-- WALLET -->
        <div id="wallet-page" class="page">
            <div style="background: #1e293b; color: white; margin: 15px; padding: 25px; border-radius: 20px;">
                <p style="font-size: 12px; opacity: 0.7;">Current Balance</p>
                <h1 style="font-size: 32px; margin: 5px 0;">₹<span id="main-bal-amt">0</span></h1>
                <button onclick="openModal('add-money-modal')" style="background: var(--primary); border:none; color:white; padding:8px 15px; border-radius:10px; margin-top:10px; font-weight:600;">+ Add Money</button>
            </div>
            <h4 style="margin: 20px 15px 10px;">Transaction History</h4>
            <div id="trans-list"></div>
        </div>

        <!-- PROFILE / ORDERS -->
        <div id="profile-page" class="page">
            <div style="background: white; margin: 15px; padding: 20px; border-radius: 20px; text-align: center; border: 1px solid var(--border);">
                <p id="disp-email" style="font-weight: 600; margin-bottom: 10px;">User</p>
                <button class="btn-main" style="background: #25D366; font-size: 13px;" onclick="contactSupport()"><i class="fa-brands fa-whatsapp"></i> WhatsApp Support</button>
                <p onclick="auth.signOut()" style="color:red; margin-top:15px; font-size:13px; font-weight:600;">Logout Account</p>
            </div>
            <h4 style="margin: 20px 15px 10px;">My Orders</h4>
            <div id="order-history"></div>
        </div>

        <!-- Navigation -->
        <div class="bottom-nav">
            <div class="nav-icon active" onclick="nav('home')"><i class="fa-solid fa-house"></i>Home</div>
            <div class="nav-icon" onclick="nav('wallet')"><i class="fa-solid fa-wallet"></i>Wallet</div>
            <div class="nav-icon" onclick="nav('profile')"><i class="fa-solid fa-clock-rotate-left"></i>Orders</div>
        </div>
    </div>

    <!-- ADD MONEY MODAL -->
    <div id="add-money-modal" class="modal">
        <div style="padding: 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px;">
            <i class="fa-solid fa-arrow-left" onclick="closeModal('add-money-modal')"></i>
            <span style="font-weight: 700;">Deposit Money</span>
        </div>
        <div style="padding: 20px;">
            <div style="background:white; padding:20px; border-radius:15px; border:1px solid #eee; margin-bottom:20px;">
                <label style="font-size:12px; color:#666;">Step 1: Enter Amount & Pay</label>
                <input type="number" id="pay-amount" class="input-box" style="margin-top:10px" placeholder="₹ Amount">
                <button class="btn-main" onclick="openInstamojo()" style="background: #733dfa;">Open Instamojo Link</button>
            </div>
            <div style="background:white; padding:20px; border-radius:15px; border:1px solid #eee;">
                <label style="font-size:12px; color:#666;">Step 2: Submit Payment ID / UTR</label>
                <input type="text" id="req-utr" class="input-box" style="margin-top:10px" placeholder="Payment ID">
                <button class="btn-main" onclick="submitDeposit()">Submit for Approval</button>
            </div>
        </div>
    </div>

    <!-- PURCHASE MODAL -->
    <div id="purchase-modal" class="modal">
        <div style="padding: 20px; display: flex; align-items: center; gap: 15px;">
            <i class="fa-solid fa-arrow-left" onclick="closeModal('purchase-modal')"></i>
            <span style="font-weight: 700;">Checkout</span>
        </div>
        <div style="padding: 20px;">
            <div style="background: white; padding: 25px; border-radius: 20px; text-align: center; border: 1px solid #eee; margin-bottom: 20px;">
                <h3 id="buy-pkg-title">...</h3>
                <h2 id="buy-pkg-price" style="color: var(--primary); margin-top:5px;">...</h2>
            </div>
            <input type="text" id="order-uid" class="input-box" placeholder="Player UID">
            <input type="text" id="order-name" class="input-box" placeholder="Game Name">
            <button class="btn-main" onclick="processOrder()">Buy Now</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCHZ4_PhE2gbJBDzipArubqJpHW88Alw5o",
            authDomain: "tournament-62f77.firebaseapp.com",
            databaseURL: "https://tournament-62f77-default-rtdb.firebaseio.com",
            projectId: "tournament-62f77",
            storageBucket: "tournament-62f77.firebasestorage.app",
            messagingSenderId: "59905181993",
            appId: "1:59905181993:web:8ad4f721ac50c09c478f38",
            measurementId: "G-QHHJ1BJWMP"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUser = null;
        let selectedPack = null;

        // AUTH LOGIC
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                document.getElementById('disp-email').innerText = user.email;
                loadData();
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
            }
        });

        function handleAuth() {
            const e = document.getElementById('login-email').value;
            const p = document.getElementById('login-pass').value;
            if (!e || p.length < 6) return alert("Enter valid email and 6-char password");

            auth.signInWithEmailAndPassword(e, p).catch(err => {
                if (err.code === 'auth/user-not-found') {
                    auth.createUserWithEmailAndPassword(e, p).then(c => {
                        db.ref('users/' + c.user.uid).set({ balance: 0, email: e });
                    });
                } else { alert(err.message); }
            });
        }

        function loadData() {
            db.ref('users/' + currentUser.uid + '/balance').on('value', s => {
                const b = s.val() || 0;
                document.getElementById('header-bal-amt').innerText = b;
                document.getElementById('main-bal-amt').innerText = b;
            });

            db.ref('packages').on('value', s => {
                const g = document.getElementById('packages-grid'); g.innerHTML = '';
                s.forEach(c => {
                    const p = c.val();
                    const div = document.createElement('div');
                    div.className = 'pkg-card';
                    div.innerHTML = `<span class="pkg-amt">${p.diamonds} DM</span><span class="pkg-price">₹${p.price}</span>`;
                    div.onclick = () => {
                        selectedPack = p;
                        openModal('purchase-modal');
                        document.getElementById('buy-pkg-title').innerText = p.diamonds + " Diamonds";
                        document.getElementById('buy-pkg-price').innerText = "₹" + p.price;
                    };
                    g.appendChild(div);
                });
            });

            loadHistory();
        }

        function loadHistory() {
            db.ref('transactions').orderByChild('uid').equalTo(currentUser.uid).on('value', snap => {
                const l = document.getElementById('trans-list'); l.innerHTML = '';
                snap.forEach(c => {
                    const t = c.val();
                    l.innerHTML += `<div class="list-item"><div><p style="font-size:13px; font-weight:600">${t.description}</p></div><div style="text-align:right"><p style="font-weight:700">₹${t.amount}</p><span class="status-badge st-${t.status}">${t.status}</span></div></div>`;
                });
            });

            db.ref('orders').orderByChild('placedByUid').equalTo(currentUser.uid).on('value', snap => {
                const l = document.getElementById('order-history'); l.innerHTML = '';
                snap.forEach(c => {
                    const o = c.val();
                    l.innerHTML += `<div class="list-item"><div><p style="font-size:13px; font-weight:600">${o.diamonds} DM</p><small>UID: ${o.targetUid}</small></div><span class="status-badge st-${o.status}">${o.status}</span></div>`;
                });
            });
        }

        function openInstamojo() {
            const amt = document.getElementById('pay-amount').value;
            if (!amt) return alert("Enter amount");
            window.open('https://www.instamojo.com/@rajeshjani121/', '_blank');
        }

        function submitDeposit() {
            const amt = parseInt(document.getElementById('pay-amount').value);
            const utr = document.getElementById('req-utr').value;
            if (!amt || !utr) return alert("Fill all fields");

            const txRef = db.ref('transactions').push();
            txRef.set({ uid: currentUser.uid, type: 'credit', amount: amt, description: 'Instamojo Deposit', status: 'pending', timestamp: Date.now() })
            .then(() => {
                db.ref('deposit_requests').push({ uid: currentUser.uid, amount: amt, utr: utr, txId: txRef.key });
                alert("Submitted!"); closeModal('add-money-modal');
            });
        }

        function processOrder() {
            const uid = document.getElementById('order-uid').value;
            const name = document.getElementById('order-name').value;
            if (!uid || !name) return alert("Fill details");
            const pr = parseInt(selectedPack.price);

            db.ref('users/' + currentUser.uid + '/balance').transaction(curr => {
                if ((curr || 0) >= pr) return curr - pr;
                return;
            }, (err, comm) => {
                if (comm) {
                    db.ref('orders').push({ placedByUid: currentUser.uid, targetUid: uid, targetName: name, diamonds: selectedPack.diamonds, price: pr, status: 'pending', timestamp: Date.now() });
                    db.ref('transactions').push({ uid: currentUser.uid, type: 'debit', amount: pr, description: 'Buy Diamonds', status: 'success', timestamp: Date.now() });
                    alert("Order Placed!"); closeModal('purchase-modal');
                } else alert("Low Balance");
            });
        }

        function nav(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id + '-page').classList.add('active');
            document.querySelectorAll('.nav-icon').forEach(n => n.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function contactSupport() { db.ref('settings/supportLink').once('value', s => { window.open(s.val(), '_blank'); }); }
        function openModal(id) { document.getElementById(id).style.display = 'block'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    </script>
</body>
</html>
